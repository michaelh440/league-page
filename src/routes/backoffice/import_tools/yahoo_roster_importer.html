<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo Roster to SQL Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        h2 {
            color: #667eea;
            margin: 25px 0 15px 0;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .step {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .file-input-group {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .file-input-group:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .file-input-group.loaded {
            border-color: #28a745;
            background: #d4edda;
        }
        .file-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            cursor: pointer;
        }
        .config-section {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        .config-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        .config-section input {
            width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .mapping-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #ffc107;
        }
        .mapping-section h3 {
            margin-bottom: 15px;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mapping-instructions {
            background: #fff3cd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mapping-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        .mapping-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        .mapping-table input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .mapping-table input:focus {
            outline: none;
            border-color: #667eea;
        }
        .mapping-table input.filled {
            border-color: #28a745;
            background: #f0f9f4;
        }
        .mapping-table tr:hover {
            background: #f8f9ff;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 20px;
        }
        button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
        }
        .output.show {
            display: block;
        }
        .stats {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }
        .stats.show {
            display: block;
        }
        .stats h3 {
            margin-bottom: 10px;
            color: #1976D2;
        }
        .copy-btn {
            background: #28a745;
            margin-bottom: 10px;
        }
        .copy-btn:hover {
            background: #218838;
        }
        .status {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
            font-weight: 500;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        .status.warning {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            display: block;
        }
        small {
            color: #666;
            display: block;
            margin-top: 5px;
            font-size: 12px;
        }
        .hidden {
            display: none;
        }
        .progress {
            background: #e9ecef;
            border-radius: 4px;
            padding: 3px;
            margin: 15px 0;
        }
        .progress-bar {
            background: #667eea;
            height: 24px;
            border-radius: 3px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèà Yahoo Roster CSV to SQL Converter</h1>
        <p class="subtitle">Convert your Yahoo Fantasy Football roster CSV files to PostgreSQL INSERT statements</p>
        
        <!-- Step 1: Upload Files -->
        <div class="step">
            <h2><span class="step-number">1</span> Upload CSV Files</h2>
            <div class="upload-section">
                <div class="file-input-group" id="rosterFileGroup">
                    <label for="rosterFile">üìÅ Player Rosters CSV</label>
                    <input type="file" id="rosterFile" accept=".csv" />
                    <small>player_rosters_2023.csv</small>
                </div>
                <div class="file-input-group" id="playersFileGroup">
                    <label for="playersFile">üìÅ Players List CSV</label>
                    <input type="file" id="playersFile" accept=".csv" />
                    <small>players_list_2023.csv</small>
                </div>
            </div>
        </div>

        <!-- Step 2: Map Team IDs -->
        <div class="step hidden" id="mappingStep">
            <h2><span class="step-number">2</span> Map Team IDs</h2>
            <div class="mapping-section">
                <h3>‚ö†Ô∏è Team ID Mapping Required</h3>
                <div class="mapping-instructions">
                    <strong>Instructions:</strong> Enter your PostgreSQL <code>manager_id</code> for each Yahoo team below. 
                    You can find these IDs by querying: <code>SELECT manager_id, team_name FROM vw_manager_team_names WHERE season_year = 2023</code>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="mappingProgress" style="width: 0%">0 of 0 mapped</div>
                </div>
                <table class="mapping-table">
                    <thead>
                        <tr>
                            <th>Yahoo Team ID</th>
                            <th>Yahoo Team Name</th>
                            <th>Your manager_id</th>
                        </tr>
                    </thead>
                    <tbody id="mappingTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Step 3: Configure -->
        <div class="step hidden" id="configStep">
            <h2><span class="step-number">3</span> Configure Import</h2>
            <div class="config-section">
                <label for="seasonId">Season ID (from your seasons table):</label>
                <input type="number" id="seasonId" value="1" min="1" />
                <small>This should match the season_id in your PostgreSQL seasons table for 2023</small>
            </div>
        </div>

        <!-- Step 4: Generate -->
        <div class="step hidden" id="generateStep">
            <h2><span class="step-number">4</span> Generate SQL</h2>
            <button id="generateBtn" disabled>Generate SQL Import Script</button>
        </div>

        <div id="status" class="status"></div>
        <div id="stats" class="stats"></div>
        
        <button id="copyBtn" class="copy-btn" style="display: none;">üìã Copy SQL to Clipboard</button>
        <div id="output" class="output"></div>
    </div>

    <script>
        let rosterData = null;
        let playersData = null;
        let teamMappings = new Map();
        let totalTeams = 0;

        const rosterFile = document.getElementById('rosterFile');
        const playersFile = document.getElementById('playersFile');
        const rosterFileGroup = document.getElementById('rosterFileGroup');
        const playersFileGroup = document.getElementById('playersFileGroup');
        const mappingStep = document.getElementById('mappingStep');
        const configStep = document.getElementById('configStep');
        const generateStep = document.getElementById('generateStep');
        const generateBtn = document.getElementById('generateBtn');
        const copyBtn = document.getElementById('copyBtn');
        const output = document.getElementById('output');
        const stats = document.getElementById('stats');
        const status = document.getElementById('status');
        const seasonIdInput = document.getElementById('seasonId');
        const mappingTableBody = document.getElementById('mappingTableBody');
        const mappingProgress = document.getElementById('mappingProgress');

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            if (type !== 'warning') {
                setTimeout(() => {
                    status.className = 'status';
                }, 5000);
            }
        }

        function updateProgress() {
            const mapped = teamMappings.size;
            const percentage = totalTeams > 0 ? (mapped / totalTeams) * 100 : 0;
            mappingProgress.style.width = percentage + '%';
            mappingProgress.textContent = `${mapped} of ${totalTeams} mapped`;
            
            if (mapped === totalTeams && totalTeams > 0) {
                configStep.classList.remove('hidden');
                generateStep.classList.remove('hidden');
                generateBtn.disabled = false;
                showStatus('‚úì All teams mapped! Ready to generate SQL.', 'success');
            } else {
                generateBtn.disabled = true;
            }
        }

        function checkFilesLoaded() {
            if (rosterData && playersData) {
                createTeamMappingTable();
            }
        }

        function createTeamMappingTable() {
            const teams = new Map();
            
            // Extract unique teams from roster data
            rosterData.forEach(row => {
                if (!teams.has(row.Team_ID)) {
                    teams.set(row.Team_ID, row.Team_Name);
                }
            });

            totalTeams = teams.size;
            
            // Clear existing table
            mappingTableBody.innerHTML = '';

            // Create mapping rows
            const sortedTeams = Array.from(teams.entries()).sort((a, b) => a[0] - b[0]);
            sortedTeams.forEach(([teamId, teamName]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${teamId}</strong></td>
                    <td>${teamName}</td>
                    <td><input type="number" class="manager-id-input" data-team-id="${teamId}" placeholder="Enter manager_id" min="1" /></td>
                `;
                mappingTableBody.appendChild(row);
            });

            mappingStep.classList.remove('hidden');
            updateProgress();
            showStatus(`Found ${totalTeams} teams. Please enter manager_id for each team.`, 'warning');

            // Add change listeners to check if all mappings are filled
            document.querySelectorAll('.manager-id-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const yahooTeamId = parseInt(e.target.dataset.teamId);
                    const managerId = parseInt(e.target.value);
                    
                    if (e.target.value && managerId > 0) {
                        teamMappings.set(yahooTeamId, managerId);
                        e.target.classList.add('filled');
                    } else {
                        teamMappings.delete(yahooTeamId);
                        e.target.classList.remove('filled');
                    }
                    
                    updateProgress();
                });
            });
        }

        rosterFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    transformHeader: (h) => h.trim(),
                    complete: (results) => {
                        rosterData = results.data;
                        rosterFileGroup.classList.add('loaded');
                        showStatus(`‚úì Loaded ${rosterData.length} roster records`, 'success');
                        checkFilesLoaded();
                    },
                    error: (error) => {
                        showStatus(`Error loading roster file: ${error.message}`, 'error');
                    }
                });
            }
        });

        playersFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    transformHeader: (h) => h.trim(),
                    complete: (results) => {
                        playersData = results.data;
                        playersFileGroup.classList.add('loaded');
                        showStatus(`‚úì Loaded ${playersData.length} player records`, 'success');
                        checkFilesLoaded();
                    },
                    error: (error) => {
                        showStatus(`Error loading players file: ${error.message}`, 'error');
                    }
                });
            }
        });

        generateBtn.addEventListener('click', () => {
            const seasonId = parseInt(seasonIdInput.value);
            const playerMap = new Map();
            
            playersData.forEach(p => {
                playerMap.set(p.Player_ID, p);
            });

            let sql = `-- Generated SQL INSERT statements for weekly_roster table\n`;
            sql += `-- Season ID: ${seasonId}\n`;
            sql += `-- Generated: ${new Date().toISOString()}\n`;
            sql += `-- Total Records: ${rosterData.length}\n\n`;
            sql += `-- Team ID Mappings (Yahoo Team ID -> manager_id):\n`;
            teamMappings.forEach((managerId, yahooId) => {
                const teamName = rosterData.find(r => r.Team_ID === yahooId)?.Team_Name;
                sql += `-- Yahoo Team ${yahooId} (${teamName}) -> manager_id ${managerId}\n`;
            });
            sql += `\nBEGIN;\n\n`;

            let positionMap = {
                'QB': 0, 'RB': 0, 'WR': 0, 'TE': 0, 'K': 0, 'DEF': 0
            };
            let lineupSlotMap = {};
            let recordsProcessed = 0;
            let recordsSkipped = 0;

            for (const row of rosterData) {
                const managerId = teamMappings.get(row.Team_ID);
                
                if (!managerId) {
                    recordsSkipped++;
                    continue;
                }

                const playerInfo = playerMap.get(row.Player_ID);
                const actualPosition = playerInfo?.Position || row.Position;

                let position;
                if (['QB', 'RB', 'WR', 'TE', 'K', 'DEF'].includes(actualPosition)) {
                    position = actualPosition;
                } else if (['QB', 'RB', 'WR', 'TE', 'K', 'DEF'].includes(row.Position)) {
                    position = row.Position;
                } else {
                    position = 'WR';
                }

                let lineupSlot;
                if (row.Position === 'W/R/T') {
                    lineupSlot = 'FLEX';
                } else if (row.Position === 'BN') {
                    lineupSlot = 'BN';
                } else if (row.Position === 'IR') {
                    lineupSlot = 'IR';
                } else if (row.Starter_Status === 'STARTER') {
                    lineupSlot = position;
                } else {
                    lineupSlot = 'BN';
                }

                const isStarter = row.Starter_Status === 'STARTER' ? 'TRUE' : 'FALSE';
                const playerName = row.Player_Name.replace(/'/g, "''");

                positionMap[position] = (positionMap[position] || 0) + 1;
                lineupSlotMap[lineupSlot] = (lineupSlotMap[lineupSlot] || 0) + 1;

                sql += `INSERT INTO public.weekly_roster (season_id, week, team_id, player_id, player_name, position, lineup_slot, is_starter, platform)\n`;
                sql += `VALUES (${seasonId}, ${row.Week}, ${managerId}, ${row.Player_ID || 'NULL'}, '${playerName}', '${position}', '${lineupSlot}', ${isStarter}, 'yahoo')\n`;
                sql += `ON CONFLICT (season_id, week, team_id, player_id) DO NOTHING;\n\n`;
                
                recordsProcessed++;
            }

            sql += `COMMIT;\n\n`;
            sql += `-- Verification Query\n`;
            sql += `SELECT \n`;
            sql += `    wr.week, \n`;
            sql += `    COUNT(*) as total_players,\n`;
            sql += `    COUNT(DISTINCT wr.team_id) as teams,\n`;
            sql += `    SUM(CASE WHEN wr.is_starter THEN 1 ELSE 0 END) as starters\n`;
            sql += `FROM public.weekly_roster wr\n`;
            sql += `WHERE wr.season_id = ${seasonId}\n`;
            sql += `GROUP BY wr.week\n`;
            sql += `ORDER BY wr.week;\n\n`;
            sql += `-- Query to verify team mappings\n`;
            sql += `SELECT DISTINCT \n`;
            sql += `    wr.team_id,\n`;
            sql += `    mt.team_name,\n`;
            sql += `    COUNT(*) as player_count\n`;
            sql += `FROM public.weekly_roster wr\n`;
            sql += `LEFT JOIN vw_manager_team_names mt ON wr.team_id = mt.manager_id AND mt.season_year = ${seasonId}\n`;
            sql += `WHERE wr.season_id = ${seasonId}\n`;
            sql += `GROUP BY wr.team_id, mt.team_name\n`;
            sql += `ORDER BY wr.team_id;`;

            output.textContent = sql;
            output.classList.add('show');
            copyBtn.style.display = 'block';

            // Show statistics
            let statsHTML = '<h3>Import Statistics</h3>';
            statsHTML += `<strong>Total Records Processed:</strong> ${recordsProcessed}<br>`;
            if (recordsSkipped > 0) {
                statsHTML += `<strong style="color: #d9534f;">Records Skipped (no mapping):</strong> ${recordsSkipped}<br>`;
            }
            statsHTML += `<strong>Season ID:</strong> ${seasonId}<br><br>`;
            statsHTML += `<strong>Team Mappings:</strong><br>`;
            teamMappings.forEach((managerId, yahooId) => {
                const teamName = rosterData.find(r => r.Team_ID === yahooId)?.Team_Name;
                statsHTML += `&nbsp;&nbsp;Yahoo ${yahooId} ‚Üí manager_id ${managerId} (${teamName})<br>`;
            });
            statsHTML += `<br><strong>Players by Position:</strong><br>`;
            Object.entries(positionMap).forEach(([pos, count]) => {
                statsHTML += `&nbsp;&nbsp;${pos}: ${count}<br>`;
            });
            statsHTML += `<br><strong>Players by Lineup Slot:</strong><br>`;
            Object.entries(lineupSlotMap).forEach(([slot, count]) => {
                statsHTML += `&nbsp;&nbsp;${slot}: ${count}<br>`;
            });
            
            stats.innerHTML = statsHTML;
            stats.classList.add('show');

            showStatus('‚úì SQL generated successfully! Scroll down to copy.', 'success');
            
            // Scroll to output
            output.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });

        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(output.textContent);
                copyBtn.textContent = '‚úì Copied!';
                showStatus('SQL copied to clipboard!', 'success');
                setTimeout(() => {
                    copyBtn.textContent = 'üìã Copy SQL to Clipboard';
                }, 2000);
            } catch (err) {
                showStatus('Failed to copy to clipboard', 'error');
            }
        });
    </script>
</body>
</html>